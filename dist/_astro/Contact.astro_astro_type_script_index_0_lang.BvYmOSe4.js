document.addEventListener("DOMContentLoaded",()=>{let p=0;const T=10,g=[];function c(t,e){const s=document.getElementById(`${t}-error`);s&&(s.textContent=e,s.classList.remove("hidden"))}function m(t){const e=document.getElementById(`${t}-error`);e&&e.classList.add("hidden")}function y(t){let e=!0;if(t.get("honeypot"))return console.warn("Bot detected via honeypot"),!1;const o=t.get("name");!o||o.length<2?(c("name","Имя должно содержать минимум 2 символа"),e=!1):/^[А-Яа-яA-Za-z\s]+$/.test(o)?m("name"):(c("name","Имя должно содержать только буквы"),e=!1);const i=t.get("email");i&&!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(i)?(c("email","Введите корректный email"),e=!1):m("email");const f=t.get("phone");f?/^\+?[0-9\s\-\(\)]{10,}$/.test(f)?m("phone"):(c("phone","Введите корректный номер телефона"),e=!1):(c("phone","Телефон обязателен"),e=!1);const a=t.get("message");return!a||a.length<10?(c("message","Сообщение должно содержать минимум 10 символов"),e=!1):a.length>1e3?(c("message","Сообщение слишком длинное (максимум 1000 символов)"),e=!1):m("message"),e}function x(t){const e={};for(const[s,o]of Object.entries(t))typeof o=="string"?e[s]=o.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<[^>]*>/g,"").trim():e[s]=o;return e}const I={threshold:.1,rootMargin:"0px 0px -50px 0px"},B=new IntersectionObserver(t=>{t.forEach(e=>{if(e.isIntersecting){const s=e.target.querySelector(".contact-header"),o=e.target.querySelector(".contact-form");s?.classList.add("animate-fade-in"),o?.classList.add("animate-slide-up")}})},I),b=document.getElementById("contact");b&&B.observe(b);const d=document.getElementById("contact-form"),E=document.getElementById("submit-btn"),v=document.getElementById("submit-text"),n=document.getElementById("form-status"),L=document.getElementById("form-status-text"),h=document.getElementById("form-status-indicator");let r=null,l=null;function S(){r&&(clearTimeout(r),r=null),l&&(clearTimeout(l),l=null)}function w(t=!1){if(n){if(r&&(clearTimeout(r),r=null),t){n.classList.add("hidden"),n.classList.remove("opacity-0","animate-fade-in"),n.dataset.state="hidden";return}n.classList.add("opacity-0"),l&&clearTimeout(l),l=setTimeout(()=>{n?.classList.add("hidden"),n?.classList.remove("opacity-0","animate-fade-in"),n&&(n.dataset.state="hidden"),l=null},250)}}function u(t,e,s=t!=="info"){!n||!L||!h||(S(),n.classList.remove("hidden","opacity-0"),n.classList.remove("animate-fade-in"),n.offsetWidth,n.classList.add("animate-fade-in"),L.textContent=e,n.dataset.state=t,h.classList.remove("animate-pulse"),h.offsetWidth,h.classList.add("animate-pulse"),s&&(r=setTimeout(()=>{r=null,w()},t==="error"?6e3:4e3)))}d&&d.addEventListener("submit",async t=>{if(t.preventDefault(),p>=T){u("error","Слишком много попыток отправки. Попробуйте позже.");return}const e=new FormData(d);if(!y(e)){u("error","Проверьте корректность данных формы.");return}const s=x(Object.fromEntries(e));p++,E.disabled=!0,v.textContent="ОТПРАВКА...",u("info","Отправляем сообщение...",!1);try{const i={name:s.name||"",email:s.email||"",phone:s.phone||"",message:s.message||""},f=new URLSearchParams;Object.entries(i).forEach(([O,C])=>{f.append(O,String(C??""))}),console.log("Sending data to n8n:",i);const a=await fetch("https://n8n.defl-illusion.com/webhook/contact",{method:"POST",mode:"no-cors",body:f});console.log("Response received:",a.status,a.statusText),a.type==="opaque"?console.log("Request sent successfully (no-cors mode)"):a.ok||console.warn("Non-OK response:",a.status,a.statusText),u("success","Сообщение отправлено! Мы свяжемся с вами в ближайшее время."),d.reset()}catch(i){console.error("Ошибка при отправке формы:",i),u("error","Не удалось отправить сообщение. Попробуйте ещё раз позже.")}finally{E.disabled=!1,v.textContent="ОТПРАВИТЬ СООБЩЕНИЕ"}g.forEach(i=>clearTimeout(i)),g.length=0;const o=setTimeout(()=>{p=0},3600*1e3);g.push(o)}),d?.querySelectorAll("input, textarea")?.forEach(t=>{t.addEventListener("input",()=>{const e=t.id;e&&m(e)}),t.addEventListener("blur",()=>{const e=new FormData(d);y(e)})})});
